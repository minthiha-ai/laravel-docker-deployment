name: Laravel CI/CD for API (Docker + DigitalOcean)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/user-service-app
  PROJECT_DIR: /var/www/user-service

jobs:
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ›  Set up PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd src
          composer install --prefer-dist --no-interaction --optimize-autoloader

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ”‘ Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ”§ Build and Push Docker Image
        run: |
          docker build -t $DOCKER_IMAGE:latest -f src/Dockerfile ./src
          docker push $DOCKER_IMAGE:latest

  deploy:
    name: ğŸš€ Deploy to DigitalOcean
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: ğŸ“¤ SSH & Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_SERVER_IP }}
          username: ${{ secrets.DO_SSH_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          envs: DOCKER_IMAGE,PROJECT_DIR,POSTGRESQL_DATABASE,POSTGRESQL_USERNAME,POSTGRESQL_PASSWORD,REDIS_PASSWORD,DO_SERVER_IP
          script: |
            set -e

            echo "ğŸ“ Setting up $PROJECT_DIR"
            echo "ğŸ“‚ Using PROJECT_DIR: $PROJECT_DIR"
            if [ ! -d "$PROJECT_DIR" ]; then
              mkdir -p $PROJECT_DIR
            fi
            cd $PROJECT_DIR

            echo "ğŸ“¦ Using Docker image: $DOCKER_IMAGE"

            # Ensure Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              sudo apt update && sudo apt install -y docker.io docker-compose
              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            echo "ğŸ“¦ Pulling latest code safely..."
            if [ ! -d ".git" ]; then
              git clone https://github.com/minthiha-ai/laravel-docker-deployment.git .
            else
              git reset --hard
              git pull origin main
            fi

            if ! command -v envsubst &> /dev/null; then
              echo "ğŸ”§ Installing envsubst..."
              sudo apt update && sudo apt install -y gettext
            fi

            echo "ğŸ“œ Checking .env file for docker-compose"
            if [ ! -f ".env" ]; then
              envsubst < .env.example > .env
              echo "âœ… .env created"
            else
              echo "âœ… .env already exists, skipping..."
            fi

            echo "ğŸ“œ Checking Laravel src/.env file"
            if [ ! -f "src/.env" ]; then
              envsubst < src/.env.example > src/.env
              echo "âœ… Laravel .env created"
            else
              echo "âœ… Laravel .env already exists, skipping..."
            fi

            echo "ğŸ›‘ Stopping running containers"
            docker-compose -f docker-compose.prod.yml down --remove-orphans

            echo "ğŸ§¹ Cleaning up Docker system"
            docker system prune -af

            echo "ğŸ³ Pulling latest image"
            docker pull $DOCKER_IMAGE:latest

            echo "ğŸš€ Starting containers"
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans

            echo "ğŸ” Checking APP_KEY"
            KEY=$(docker exec user_service_app php -r "echo env('APP_KEY');")
            if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
              echo "âš¡ No APP_KEY found. Generating..."
              docker exec user_service_app php artisan key:generate --force
            else
              echo "âœ… APP_KEY already set."
            fi

            echo "â³ Waiting for Laravel to be ready..."
            attempts=0
            until docker exec user_service_app php artisan migrate:status > /dev/null 2>&1; do
              attempts=$((attempts+1))
              echo "âŒ› Attempt $attempts: Laravel not ready..."
              if [ "$attempts" -ge 20 ]; then
                echo "âŒ Timeout: Laravel not ready after $attempts attempts"
                docker logs user_service_app
                exit 1
              fi
              sleep 5
            done
            echo "âœ… Laravel is ready!"

            echo "ğŸ“¦ Running migrations"
            docker exec user_service_app php artisan migrate --force

            echo "ğŸ”§ Optimizing config & routes"
            docker exec user_service_app php artisan optimize:clear
            docker exec user_service_app php artisan config:cache
            docker exec user_service_app php artisan route:cache

            echo "âœ… Deployment Completed!"
