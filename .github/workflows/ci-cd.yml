name: Laravel Full CI/CD with Docker & DigitalOcean

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  APP_NAME: laravel-app
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/user-service-app
  PROJECT_DIR: /var/www/user-service

jobs:
  build-and-test:
    name: ğŸ— Build, Test & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ›  Set up PHP & Composer
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd src  # Ensure the script runs inside the Laravel project folder
          composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader

      - name: ğŸ§ª Run Tests
        run: |
          cd src
          vendor/bin/phpunit

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ”‘ Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“¦ Build and Push Docker Image (With Caching)
        run: |
          docker build --cache-from=type=registry,ref=$DOCKER_IMAGE:latest \
          --build-arg APP_ENV=production -t $DOCKER_IMAGE:latest -f php/Dockerfile .
          docker push $DOCKER_IMAGE:latest

  deploy:
    name: ğŸš€ Fully Automated Deployment to DigitalOcean
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: ğŸ“¤ Deploy & Setup Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DO_SERVER_IP }}
          username: ${{ secrets.DO_SSH_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            bash /var/www/user-service/deployment/deploy.sh

            # Ensure necessary directories exist
            sudo mkdir -p $PROJECT_DIR
            sudo chown -R $USER:$USER $PROJECT_DIR
            cd $PROJECT_DIR

            # Install dependencies if not installed (one-time setup)
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              sudo apt update && sudo apt install -y docker.io docker-compose
              sudo usermod -aG docker $USER
              newgrp docker
            fi

            # Ensure correct project directory
            cd $PROJECT_DIR

            # Clone or Update Repository
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Cloning Repository..."
              git clone https://github.com/minthiha-ai/laravel-docker-deployment.git .
            else
              echo "ğŸ“¥ Pulling Latest Code..."
              git pull origin main
            fi

            # Copy Environment Variables
            cp deployment/.env.prod .env
            echo "âœ… Environment variables set up"

            # Stop Old Containers
            echo "ğŸ³ Stopping existing containers..."
            docker-compose -f deployment/docker-compose.prod.yml down

            # Pull Latest Docker Image
            echo "ğŸ³ Pulling latest Docker image..."
            docker pull $DOCKER_IMAGE:latest

            # Start New Containers
            echo "ğŸ³ Starting new containers..."
            docker-compose -f deployment/docker-compose.prod.yml up -d --remove-orphans

            # Verify Running Containers
            echo "ğŸ“Š Checking running containers..."
            docker ps -a

            # Run Database Migrations
            echo "ğŸ”„ Running database migrations..."
            docker exec user_service_app php artisan migrate --force

            # Fix Permissions
            echo "ğŸ”§ Fixing storage & permissions..."
            docker exec laravel_app chmod -R 777 storage bootstrap/cache

            echo "âœ… Deployment complete!"
